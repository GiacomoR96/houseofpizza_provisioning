---
- name: Configure Ubuntu 24.04
  hosts: your_target_host
  become: yes

  tasks:
    - name: Install AWS CLI client
      block:
        - name: Download AWS CLI
          shell: "curl -o awscliv2.zip https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip"
        
        - name: Install unzip
          apt:
            name: unzip
            state: present
        
        - name: Extract AWS CLI
          shell: "unzip awscliv2.zip > /dev/null"
        
        - name: Run AWS CLI installer
          shell: "sudo ./aws/install"
      tags: 
        - aws_cli

    - name: Tag subnets
      block:
        - name: Tag subnets
          shell: "for SUBNET in $AWS_SUBNETS; do aws ec2 create-tags --resources $SUBNET --tags Key=kubernetes.io/cluster/$CLUSTER_NAME,Value=shared --region $AWS_REGION; done"
      tags:
        - tag_subnets

    - name: Install Containerd
      block:
        - name: Disable swap
          command: "swapoff -a"
        
        - name: Configure kernel modules and sysctl
          command: "modprobe overlay && modprobe br_netfilter"
        
        - name: Configure sysctl
          copy:
            dest: "/etc/sysctl.d/kubernetes.conf"
            content: |
              net.bridge.bridge-nf-call-ip6tables = 1
              net.bridge.bridge-nf-call-iptables = 1
              net.ipv4.ip_forward = 1
        
        - name: Configure modules load
          copy:
            dest: "/etc/modules-load.d/k8s.conf"
            content: |
              overlay
              br_netfilter
        
        - name: Apply sysctl settings
          command: "sysctl --system"
        




        
        - name: Add Docker GPG key
          shell: "curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/trusted.gpg.d/docker.gpg"
        
        - name: Add Docker repository
          copy:
            dest: "/etc/apt/sources.list.d/docker.list"
            content: |
              deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable
        
        - name: Install Containerd
          apt:
            name: containerd.io
            state: present
        
        - name: Configure Containerd
          shell: "sudo mkdir -p /etc/containerd && sudo containerd config default | sudo tee /etc/containerd/config.toml"

        - name: Restart Containerd
          systemd:
            name: containerd
            state: restarted
            enabled: yes
      tags:
        - containerd

    - name: Install Kubernetes components
      block:
        - name: Add Kubernetes APT key
          shell: "curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add -"
        
        - name: Add Kubernetes repository
          shell: "echo 'deb https://apt.kubernetes.io/ kubernetes-xenial main' | sudo tee /etc/apt/sources.list.d/kubernetes.list"
        
        - name: Install Kubernetes components
          apt:
            name: "{{ item }}"
            state: present
          with_items:
            - apt-transport-https
            - ca-certificates
            - curl
            - gnupg
            - kubeadm
            - kubelet
          notify: Restart kubelet

        - name: Configure Kubectl
          shell: "curl -LO https://dl.k8s.io/release/v1.31.0/bin/linux/amd64/kubectl && sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl"

      tags:
        - kubernetes_components

  handlers:
    - name: Restart kubelet
      systemd:
        name: kubelet
        state: restarted
        enabled: yes